---
title: Troubleshooting Guide
description: Common issues and solutions for Civic Labs integrations
---

## Overview

This guide helps you diagnose and resolve common issues with Civic Labs integrations. Use the diagnostic tools and solutions provided to quickly identify and fix problems.

## Quick Diagnostics

### Check System Status

```bash
# Check Civic Labs service status
curl https://status.civic-labs.com/api/v2/status.json

# Test your API key
curl -X GET https://api.civic-labs.com/mcp/v1/health \
  -H "Authorization: Bearer YOUR_API_KEY"

# List available tools
curl -X GET https://api.civic-labs.com/mcp/v1/tools \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### SDK Diagnostics

```javascript
// JavaScript diagnostic script
const { CivicLabsClient } = require('@civic/labs-sdk');

async function runDiagnostics() {
  const client = new CivicLabsClient({
    apiKey: process.env.CIVIC_LABS_API_KEY,
    debug: true
  });
  
  console.log('Running diagnostics...\n');
  
  // Test 1: API connectivity
  try {
    const health = await client.health.check();
    console.log('✅ API Connectivity:', health.status);
  } catch (error) {
    console.log('❌ API Connectivity:', error.message);
  }
  
  // Test 2: Authentication
  try {
    const tools = await client.tools.list();
    console.log('✅ Authentication: Valid');
    console.log(`   Available tools: ${tools.length}`);
  } catch (error) {
    console.log('❌ Authentication:', error.message);
  }
  
  // Test 3: Tool execution
  try {
    const result = await client.tools.execute('echo', { 
      message: 'test' 
    });
    console.log('✅ Tool Execution: Working');
  } catch (error) {
    console.log('❌ Tool Execution:', error.message);
  }
  
  // Test 4: OAuth status
  try {
    const auths = await client.auth.list();
    console.log('✅ OAuth Status:');
    auths.forEach(auth => {
      console.log(`   - ${auth.service}: ${auth.status}`);
    });
  } catch (error) {
    console.log('❌ OAuth Status:', error.message);
  }
}

runDiagnostics();
```

## Common Issues

### Authentication Errors

#### Issue: 401 Unauthorized
```
Error: Request failed with status code 401
Message: Invalid or missing API key
```

**Solutions:**
1. Verify API key is correct:
   ```bash
   echo $CIVIC_LABS_API_KEY
   ```

2. Check API key format:
   ```javascript
   // Correct format
   const apiKey = 'clk_live_xxxxxxxxxxxxxxxx';
   
   // Common mistakes
   const wrong1 = 'Bearer clk_live_xxx'; // Don't include "Bearer"
   const wrong2 = '"clk_live_xxx"'; // Don't include quotes
   ```

3. Verify API key permissions:
   ```bash
   curl -X GET https://api.civic-labs.com/auth/v1/key/info \
     -H "Authorization: Bearer YOUR_API_KEY"
   ```

#### Issue: 403 Forbidden
```
Error: Access denied to resource
```

**Solutions:**
1. Check tool permissions:
   ```javascript
   const permissions = await client.auth.getPermissions();
   console.log('Allowed tools:', permissions.tools);
   ```

2. Verify OAuth scopes:
   ```javascript
   const auth = await client.auth.get('github');
   console.log('Granted scopes:', auth.scopes);
   ```

### Connection Issues

#### Issue: ECONNREFUSED
```
Error: connect ECONNREFUSED 52.234.123.45:443
```

**Solutions:**
1. Check network connectivity:
   ```bash
   # Test DNS resolution
   nslookup api.civic-labs.com
   
   # Test connection
   telnet api.civic-labs.com 443
   
   # Test with curl
   curl -v https://api.civic-labs.com/health
   ```

2. Check proxy settings:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     proxy: process.env.HTTPS_PROXY
   });
   ```

3. Verify firewall rules allow outbound HTTPS to:
   - `api.civic-labs.com` (52.234.123.0/24)
   - `auth.civic-labs.com` (52.234.124.0/24)

#### Issue: Timeout Errors
```
Error: Request timeout of 30000ms exceeded
```

**Solutions:**
1. Increase timeout:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     timeout: 60000 // 60 seconds
   });
   ```

2. Use async execution for long operations:
   ```javascript
   const job = await client.tools.executeAsync('analyze-repository', {
     repo: 'large-repo'
   });
   
   // Poll for results
   const result = await client.jobs.wait(job.id, {
     pollInterval: 5000,
     maxWait: 300000
   });
   ```

### Rate Limiting

#### Issue: 429 Too Many Requests
```
Error: Rate limit exceeded
Headers:
  X-RateLimit-Limit: 60
  X-RateLimit-Remaining: 0
  X-RateLimit-Reset: 1640995200
```

**Solutions:**
1. Implement exponential backoff:
   ```javascript
   async function executeWithRetry(tool, params, attempts = 3) {
     for (let i = 0; i < attempts; i++) {
       try {
         return await client.tools.execute(tool, params);
       } catch (error) {
         if (error.status === 429 && i < attempts - 1) {
           const delay = Math.pow(2, i) * 1000;
           console.log(`Rate limited, waiting ${delay}ms`);
           await new Promise(resolve => setTimeout(resolve, delay));
         } else {
           throw error;
         }
       }
     }
   }
   ```

2. Use batch operations:
   ```javascript
   // Instead of multiple calls
   for (const item of items) {
     await client.tools.execute('process', item);
   }
   
   // Use batch
   const results = await client.tools.executeBatch(
     items.map(item => ({ tool: 'process', params: item }))
   );
   ```

3. Enable caching:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     cache: {
       enabled: true,
       ttl: 3600
     }
   });
   ```

### OAuth Issues

#### Issue: OAuth Flow Fails
```
Error: OAuth callback failed: state mismatch
```

**Solutions:**
1. Verify redirect URI:
   ```javascript
   // Check registered redirect URI matches exactly
   const authUrl = await client.auth.getAuthorizationUrl('github', {
     redirectUri: 'https://app.com/callback', // Must match exactly
     state: crypto.randomUUID()
   });
   ```

2. Check state parameter:
   ```javascript
   // Store state before redirect
   session.oauthState = crypto.randomUUID();
   const authUrl = await client.auth.getAuthorizationUrl('github', {
     state: session.oauthState
   });
   
   // Verify state in callback
   if (callbackState !== session.oauthState) {
     throw new Error('State mismatch - possible CSRF attack');
   }
   ```

#### Issue: Token Expired
```
Error: OAuth token expired for service: github
```

**Solutions:**
1. Automatic refresh:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     oauth: {
       autoRefresh: true,
       refreshBuffer: 300 // Refresh 5 min before expiry
     }
   });
   ```

2. Manual refresh:
   ```javascript
   try {
     await client.tools.execute('github-search', params);
   } catch (error) {
     if (error.code === 'OAUTH_EXPIRED') {
       await client.auth.refresh('github');
       // Retry
       await client.tools.execute('github-search', params);
     }
   }
   ```

### Security Errors

#### Issue: Bodyguard Blocks Request
```
Error: Security threat detected
Details: {
  threatScore: 0.92,
  findings: ["prompt_injection", "data_exfiltration"]
}
```

**Solutions:**
1. Review the prompt:
   ```javascript
   // Test prompt before sending
   const analysis = await client.security.analyze(userPrompt);
   if (analysis.threatScore > 0.8) {
     console.warn('High threat score:', analysis.findings);
     // Sanitize or reject
   }
   ```

2. Adjust threshold:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     security: {
       bodyguard: {
         threshold: 0.9, // Less sensitive
         logOnly: true   // Don't block, just log
       }
     }
   });
   ```

#### Issue: Guardrail Policy Violation
```
Error: Request blocked by guardrail policy
Policy: domain-allowlist
Details: Domain 'unsafe.com' not in allowlist
```

**Solutions:**
1. Check policy configuration:
   ```javascript
   const policies = await client.guardrails.list();
   console.log('Active policies:', policies);
   ```

2. Request policy exception:
   ```javascript
   // For specific request
   const result = await client.tools.execute('fetch', {
     url: 'https://example.com'
   }, {
     bypassPolicies: ['domain-allowlist'], // Requires permission
     reason: 'Trusted partner API'
   });
   ```

### Performance Issues

#### Issue: Slow Response Times
```
Tool execution taking 30+ seconds
```

**Solutions:**
1. Enable performance monitoring:
   ```javascript
   client.on('request', (event) => {
     console.time(`request-${event.id}`);
   });
   
   client.on('response', (event) => {
     console.timeEnd(`request-${event.id}`);
     if (event.duration > 5000) {
       console.warn(`Slow request: ${event.path} took ${event.duration}ms`);
     }
   });
   ```

2. Use connection pooling:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     http: {
       keepAlive: true,
       maxSockets: 50
     }
   });
   ```

3. Enable compression:
   ```javascript
   const client = new CivicLabsClient({
     apiKey: process.env.CIVIC_LABS_API_KEY,
     compression: true
   });
   ```

## Debug Mode

### Enable Verbose Logging

```javascript
// Set environment variable
process.env.CIVIC_LABS_DEBUG = 'true';
process.env.CIVIC_LABS_LOG_LEVEL = 'debug';

const client = new CivicLabsClient({
  apiKey: process.env.CIVIC_LABS_API_KEY,
  debug: true,
  logger: {
    debug: (...args) => console.log('[DEBUG]', ...args),
    info: (...args) => console.log('[INFO]', ...args),
    warn: (...args) => console.warn('[WARN]', ...args),
    error: (...args) => console.error('[ERROR]', ...args)
  }
});
```

### Capture HTTP Traffic

```javascript
// Log all HTTP requests/responses
client.on('http:request', ({ method, url, headers, body }) => {
  console.log('REQUEST:', { method, url, headers, body });
});

client.on('http:response', ({ status, headers, body, duration }) => {
  console.log('RESPONSE:', { status, headers, body, duration });
});
```

### Use Request Tracing

```javascript
// Enable tracing
const client = new CivicLabsClient({
  apiKey: process.env.CIVIC_LABS_API_KEY,
  tracing: {
    enabled: true,
    serviceName: 'my-app'
  }
});

// Access trace ID
client.on('request', (event) => {
  console.log('Trace ID:', event.traceId);
  // Use this ID when contacting support
});
```

## Getting Help

### Self-Service Resources

1. **API Status**: Check [status.civic-labs.com](https://status.civic-labs.com)
2. **Documentation**: Review [docs.civic.com/labs](https://docs.civic.com/labs)
3. **Examples**: See [github.com/civic-labs/examples](https://github.com/civic-labs/examples)
4. **Community**: Join [Discord](https://discord.gg/civic-labs)

### Contacting Support

When contacting support, include:

```javascript
// Generate support bundle
async function generateSupportBundle() {
  const bundle = {
    timestamp: new Date().toISOString(),
    environment: {
      node: process.version,
      platform: process.platform,
      sdk: require('@civic/labs-sdk/package.json').version
    },
    diagnostics: await runDiagnostics(),
    recentErrors: getRecentErrors(),
    configuration: {
      endpoint: client.config.endpoint,
      timeout: client.config.timeout,
      // Don't include API key!
    }
  };
  
  fs.writeFileSync('civic-support-bundle.json', 
    JSON.stringify(bundle, null, 2)
  );
}
```

### Emergency Contacts

- **Critical Issues**: [emergency@civic-labs.com](mailto:emergency@civic-labs.com)
- **Enterprise Support**: Available 24/7 for enterprise customers
- **Security Issues**: [security@civic-labs.com](mailto:security@civic-labs.com)

## Common Error Codes

| Code | Description | Solution |
|------|-------------|----------|
| `AUTH_INVALID` | Invalid API key | Check API key format and validity |
| `AUTH_EXPIRED` | Expired authentication | Refresh tokens or re-authenticate |
| `RATE_LIMITED` | Too many requests | Implement backoff and retry |
| `TOOL_NOT_FOUND` | Unknown tool | Check tool name and availability |
| `PARAM_INVALID` | Invalid parameters | Verify parameter types and requirements |
| `OAUTH_REQUIRED` | OAuth needed | Complete OAuth flow for service |
| `SECURITY_THREAT` | Bodyguard blocked | Review and sanitize input |
| `POLICY_VIOLATION` | Guardrail blocked | Check policy requirements |
| `TIMEOUT` | Request timeout | Increase timeout or use async |
| `SERVER_ERROR` | Internal error | Retry or contact support |