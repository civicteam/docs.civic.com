---
title: "Express"
description: "Follow these simple steps to set up Civic Auth with an [Express](https://expressjs.com/) backend (a working example is available in our [github examples repo](https://github.com/civicteam/civic-auth-examples/tree/main/packages/civic-auth/server/express))."
icon: js
public: true
---

## 1. Install dependencies

<CodeGroup>
  ```npm npm
  npm install @civic/auth cookie-parser
  ```

```yarn yarn
yarn add @civic/auth cookie-parser
```

```pnpm pnpm
pnpm install @civic/auth cookie-parser
```

```bun bun
bun add @civic/auth cookie-parser
```

</CodeGroup>

## 2. Setup with CivicAuthServer (Recommended)

ðŸš€ **NEW SIMPLIFIED APPROACH**: The easiest way to set up Civic Auth with Express is using the `CivicAuthServer` middleware that automatically handles all auth routes, storage, and CORS configuration.

This approach eliminates the need for manual endpoint creation, cookie storage setup, and CORS configuration. The middleware automatically creates all necessary auth routes and handles session management, making it perfect for both traditional server-rendered apps and modern SPA architectures.

```ts
import express from "express";
import cookieParser from "cookie-parser";
import { CivicAuthServer } from "@civic/auth/server";

const app = express();

app.use(cookieParser());

// ðŸš€ ONE LINE SETUP: Everything is handled automatically!
app.use(
  CivicAuthServer({
    clientId: process.env.CLIENT_ID!,
    redirectUrl: `http://localhost:3020/auth/callback`,
    postLogoutRedirectUrl: `http://localhost:3020/`,
  }),
);
```

### Configuration Options

| Field                   | Required | Default                        | Description                                                             |
| ----------------------- | -------- | ------------------------------ | ----------------------------------------------------------------------- |
| `clientId`              | Yes      | -                              | Your Civic Auth client ID from [auth.civic.com](https://auth.civic.com) |
| `redirectUrl`           | Yes      | -                              | OAuth redirect URL after authentication                                 |
| `postLogoutRedirectUrl` | Yes      | -                              | URL to redirect to after logout                                         |
| `frontendRedirectUrl`   | No       | -                              | Redirect SPAs back to frontend after auth                               |
| `oauthServer`           | No       | `https://auth.civic.com/oauth` | OAuth server URL (for development/testing)                              |
| `cors`                  | No       | Auto-configured                | CORS settings (see Advanced Configuration)                              |
| `logger`                | No       | `{ enabled: true }`            | Logging configuration                                                   |

### Options (Second Parameter)

| Field     | Required | Default | Description                                                 |
| --------- | -------- | ------- | ----------------------------------------------------------- |
| `routes`  | No       | -       | Custom route handler overrides (see Advanced Configuration) |
| `storage` | No       | -       | Custom storage class or factory function                    |

## 3. Add Authentication Middleware

Protect routes that require login:

```ts
import { Request, Response, NextFunction } from "express";
import type { CivicAuth, SessionStorage } from "@civic/auth/server";

// Type for requests with auth properties (auto-added by CivicAuthServer)
type RequestWithAuth = Request & {
  storage?: SessionStorage;
  civicAuth?: CivicAuth;
};

const authMiddleware = async (req: RequestWithAuth, res: Response, next: NextFunction) => {
  if (!(await req.civicAuth!.isLoggedIn())) {
    return res.status(401).send("Unauthorized");
  }
  next();
};

// Apply authentication middleware to protected routes
app.use("/admin", authMiddleware);
```

## 4. Use Protected Routes

Access user information in your protected routes:

```ts
app.get("/admin/hello", async (req: RequestWithAuth, res: Response) => {
  const user = await req.civicAuth!.getUser();
  res.send(`Hello, ${user?.name || user?.email || "User"}!`);
});

// Optional: Manual token refresh
app.get("/admin/refresh", async (req: RequestWithAuth, res: Response) => {
  await req.civicAuth!.refreshTokens();
  res.send("Tokens refreshed");
});
```

## 5. Automatic Routes

When using `CivicAuthServer`, these routes are automatically created for you:

- `GET /auth/login` - Redirects to Civic Auth login
- `GET /auth/callback` - Handles OAuth callback
- `GET /auth/logout` - Handles logout and redirects to `postLogoutRedirectUrl`
- `GET /auth/user` - Returns current user info (if logged in)
- `POST /auth/refresh` - Refreshes tokens

You can trigger login from any route:

```ts
app.get("/", async (req: RequestWithAuth, res: Response) => {
  const url = await req.civicAuth!.buildLoginUrl();
  res.redirect(url.toString());
});
```

## 6. Frontend Integration (Vanilla JavaScript)

Use the `@civic/auth/vanillajs` client with your backend:

```javascript
import { CivicAuth } from "@civic/auth/vanillajs";

// Configure client to use your backend for login URLs
const authClient = await CivicAuth.create({
  loginUrl: "http://localhost:3020/auth/login-url", // Your backend endpoint
});

// Now authentication works through your backend
const { user } = await authClient.startAuthentication();
```

Add this endpoint to expose login URLs:

```ts
app.get("/auth/login-url", async (req: RequestWithAuth, res: Response) => {
  const loginUrl = await req.civicAuth!.buildLoginUrl();
  res.json({ loginUrl: loginUrl.toString() });
});
```

## Manual Setup (Advanced)

<details>
<summary>If you need custom storage or more control, you can still set up Civic Auth manually:</summary>

### Configure your App

```ts
const config = {
  clientId: process.env.CLIENT_ID!,
  redirectUrl: "http://localhost:3000/auth/callback",
  postLogoutRedirectUrl: "http://localhost:3000/",
};
```

### Set up Custom Storage

```ts
import { CookieStorage, CivicAuth } from "@civic/auth/server";

class ExpressCookieStorage extends CookieStorage {
  constructor(
    private req: Request,
    private res: Response,
  ) {
    super({
      secure: false,
    });
  }

  async get(key: string): Promise<string | null> {
    return Promise.resolve(this.req.cookies[key] ?? null);
  }

  async set(key: string, value: string): Promise<void> {
    await this.res.cookie(key, value, this.settings);
  }
}

app.use((req, res, next) => {
  req.storage = new ExpressCookieStorage(req, res);
  req.civicAuth = new CivicAuth(req.storage, config);
  next();
});
```

### Create Manual Endpoints

```ts
// Login endpoint
app.get("/auth/login", async (req: Request, res: Response) => {
  const url = await req.civicAuth.buildLoginUrl();
  res.redirect(url.toString());
});

// Logout endpoint
app.get("/auth/logout", async (req: Request, res: Response) => {
  const url = await req.civicAuth.buildLogoutRedirectUrl();
  res.redirect(url.toString());
});

// Callback endpoint
app.get("/auth/callback", async (req: Request, res: Response) => {
  const { code, state } = req.query as { code: string; state: string };
  await req.civicAuth.resolveOAuthAccessCode(code, state);
  res.redirect("/admin/hello");
});
```

</details>

## Advanced Configuration

### Custom Route Handlers

You can override any of the automatic auth routes by providing custom implementations:

```ts
app.use(
  CivicAuthServer(config, {
    routes: {
      login: async (req, res) => {
        // Custom login logic
        const url = await req.civicAuth!.buildLoginUrl();
        res.redirect(url.toString());
      },
      callback: async (req, res) => {
        // Custom callback logic
        const { code, state } = req.query;
        await req.civicAuth!.handleCallback({ code, state, req });
        res.redirect("/dashboard");
      },
      logout: async (req, res) => {
        // Custom logout logic
        const url = await req.civicAuth!.buildLogoutRedirectUrl();
        res.redirect(url.toString());
      },
      user: async (req, res) => {
        // Custom user endpoint logic
        const user = await req.civicAuth!.getUser();
        res.json({ user, timestamp: Date.now() });
      },
      refresh: async (req, res) => {
        // Custom refresh logic
        await req.civicAuth!.refreshTokens();
        res.json({ success: true });
      },
    },
  }),
);
```

Available route overrides:

- `login` - `/auth/login`
- `callback` - `/auth/callback`
- `logout` - `/auth/logout`
- `logoutCallback` - `/auth/logoutcallback`
- `user` - `/auth/user`
- `refresh` - `/auth/refresh`

### Cookie Storage Interface

The Express middleware automatically creates a cookie storage implementation that handles session management. Here's how it works:

```ts
// Auto-configured cookie settings
class ExpressCookieStorage extends CookieStorage {
  constructor(req: Request, res: Response) {
    // Detects HTTPS vs HTTP for security
    const isHttps = req.secure || req.headers["x-forwarded-proto"] === "https";

    super({
      secure: isHttps, // Secure cookies for HTTPS
      sameSite: isHttps ? "none" : "lax", // Cross-origin for HTTPS
      httpOnly: false, // Allow frontend access
      path: "/", // Available for all paths
    });
  }

  async get(key: string): Promise<string | null> {
    return this.req.cookies[key] ?? null;
  }

  async set(key: string, value: string): Promise<void> {
    this.res.cookie(key, value, this.settings);
    this.req.cookies[key] = value; // Immediate access
  }

  async delete(key: string): Promise<void> {
    this.res.clearCookie(key);
  }
}
```

**Custom Cookie Storage:**

You can provide your own storage implementation in three ways:

```ts
// Option 1: Pass storage class directly (recommended)
app.use(
  CivicAuthServer(config, {
    storage: YourCustomCookieStorage, // Will be instantiated with (req, res)
  }),
);
```

```ts
// Option 2: Pass a factory function
app.use(
  CivicAuthServer(config, {
    storage: (req, res) => new YourCustomCookieStorage(req, res),
  }),
);
```

```ts
// Option 3: Set up in middleware (backwards compatibility)
app.use((req, res, next) => {
  req.storage = new YourCustomCookieStorage(req, res);
  req.civicAuth = new CivicAuth(req.storage, config);
  next();
});

app.use(CivicAuthServer(config)); // Will use your custom storage
```

The middleware automatically detects existing `req.storage` and `req.civicAuth` and uses them instead of creating defaults.

### CORS Options

The `cors` field accepts these options:

| Field         | Default                             | Description                                                 |
| ------------- | ----------------------------------- | ----------------------------------------------------------- |
| `origin`      | Auto-detected from your URLs        | Array of allowed origins, merged with auto-detected origins |
| `credentials` | `true`                              | Include credentials (cookies) in CORS requests              |
| `methods`     | `['GET', 'POST', 'PUT', 'DELETE']`  | Allowed HTTP methods                                        |
| `headers`     | `['Content-Type', 'Authorization']` | Allowed request headers                                     |

Example:

```ts
cors: {
  origin: ["https://additional-domain.com"], // Merged with auto-detected
  credentials: true,
}
```

## PKCE and Client Secrets

Civic Auth uses [**PKCE** (Proof Key for Code Exchange)](https://oauth.net/2/pkce/), to protect users and clients from unauthorized access to user information. This, alongside domain registration for apps in production environments, mean that you don't need to provide a client secret in your backend.

When using the Civic Auth SDK, PKCE is handled entirely by the library.
